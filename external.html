<!-- external.html (External Web Form Integration / API) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UCPM ‚Äì External Web Form (API)</title>

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #f6f7f9; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 24px; }
    .card { background: #fff; border-radius: 12px; padding: 18px; margin: 18px 0; box-shadow: 0 2px 10px rgba(0,0,0,.06); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 12px 0; }
    label { display: grid; gap: 6px; font-size: 14px; }
    input { padding: 10px 12px; border: 1px solid #d7dbe0; border-radius: 10px; font-size: 14px; }
    .checkbox { display: flex; align-items: center; gap: 8px; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; align-items: center; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #d7dbe0; background: #fff; cursor: pointer; }
    button:hover { background: #f2f4f7; }
    .muted { color: #6b7280; font-size: 13px; }
    .log { margin-top: 14px; border: 1px dashed #d7dbe0; border-radius: 12px; padding: 12px; background: #fafafa; }
    .log pre { margin: 0; white-space: pre-wrap; word-break: break-word; font-size: 12px; }

    /* ‚úÖ Top bar (old selector-style) */
    .topbar{
      margin-bottom: 16px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }
    .back-btn {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 14px; border-radius: 999px; text-decoration: none;
      font-size: 13px; font-weight: 600; color: #1d4ed8;
      background: rgba(37,99,235,.08); border: 1px solid rgba(37,99,235,.25);
      transition: all .15s ease;
      white-space: nowrap;
    }
    .back-btn:hover { background: rgba(37,99,235,.15); }

    /* üîê Token Vault (top-right chip + popover) */
    details.vaultTopRight{ position: relative; margin-left: auto; }
    summary.vaultChip{
      list-style: none;
      cursor: pointer;
      display:inline-flex;
      align-items:center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: rgba(255,255,255,.9);
      font-size: 12.5px;
      font-weight: 900;
      color:#0f172a;
      user-select:none;
      white-space: nowrap;
    }
    summary.vaultChip::-webkit-details-marker{ display:none; }
    .vaultChipRight{
      display:flex; align-items:center; gap: 8px;
      font-weight: 800; font-size: 12px;
      color:#64748b;
      padding: 5px 8px;
      border: 1px solid #e5e7eb;
      border-radius: 999px;
      background: rgba(255,255,255,.8);
      white-space: nowrap;
    }
    .dot { width:8px; height:8px; border-radius: 999px; background:#ef4444; }
    .dot.ok { background:#22c55e; }

    .vaultPopover{
      position: absolute;
      right: 0;
      top: calc(100% + 10px);
      width: min(520px, 86vw);
      border: 1px solid #eef0f3;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 18px 50px rgba(2, 6, 23, .14);
      padding: 10px 12px 12px;
      z-index: 50;
    }
    textarea.vaultInput{
      width:100%;
      min-height: 60px;
      resize: vertical;
      padding: 8px 10px;
      border: 1px solid #d7dbe0;
      border-radius: 10px;
      font-size: 12px;
      line-height: 1.3;
      outline: none;
      background: #fff;
    }
    textarea.vaultInput:focus{
      border-color: rgba(37,99,235,.6);
      box-shadow: 0 0 0 3px rgba(37,99,235,.10);
    }
    .vaultActions{
      display:flex; gap: 8px; flex-wrap: wrap;
      margin-top: 8px; align-items:center;
    }
    .btnSm{
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #fff;
      font-size: 12px;
      font-weight: 800;
      cursor: pointer;
      white-space: nowrap;
    }
    .btnSm:hover{ background:#f8fafc; }
    .btnPrimary{
      border-color: rgba(37,99,235,.30);
      background: rgba(37,99,235,.10);
      color:#1d4ed8;
    }
    .btnDanger{
      border-color: rgba(239,68,68,.30);
      background: rgba(239,68,68,.08);
      color:#b91c1c;
    }
    .vaultHint{
      margin: 8px 0 0;
      font-size: 11.5px;
      color:#64748b;
      line-height: 1.35;
    }
    code.k { font-size: 11.5px; }

    @media (max-width: 720px) { .row { grid-template-columns: 1fr; } }
    @media (max-width: 520px){
      .topbar{ flex-direction: column; align-items: flex-start; }
      details.vaultTopRight{ margin-left: 0; }
      .vaultPopover{ left: 0; right: auto; width: 92vw; }
    }
  </style>
</head>

<body>
  <main class="wrap">
    <div class="topbar">
      <a href="./index.html" class="back-btn">‚Üê Back to selector</a>

      <details class="vaultTopRight" id="vaultDetails">
        <summary class="vaultChip" title="Token Vault (requestInformation JWT)">
          <span>‚öôÔ∏è Token Vault</span>
          <span class="vaultChipRight">
            <span class="dot" id="vaultDot"></span>
            <span id="vaultText">Not loaded</span>
          </span>
        </summary>

        <div class="vaultPopover">
          <textarea class="vaultInput" id="jwtInput" placeholder="Paste the Collection Point JWT here (not committed)‚Ä¶"></textarea>

          <div class="vaultActions">
            <button class="btnSm btnPrimary" type="button" id="btnSaveJwt">Save</button>
            <button class="btnSm btnDanger" type="button" id="btnClearJwt">Clear</button>
          </div>

          <p class="vaultHint">
            Stored in <strong>sessionStorage</strong> (this tab only). Key:
            <code class="k">sessionStorage["ucpm_requestInformation_jwt"]</code>
          </p>
        </div>
      </details>
    </div>

    <h1>External Web Form Integration (API)</h1>

    <section class="card">
      <h2>CMS-like Form ‚Üí Consent Receipt API</h2>
      <p class="muted">
        Sends a consent receipt to your Collection Point via <code>/request/v1/consentreceipts</code> using the Collection Point JWT as <code>requestInformation</code>.
      </p>

      <form id="externalForm">
        <div class="row">
          <label>Email (identifier)
            <input id="email" type="email" required placeholder="example@otprivacy.com" />
          </label>
          <label>Mobile
            <input id="phone" type="tel" placeholder="+34..." />
          </label>
        </div>

        <div class="row">
          <label>First Name
            <input id="firstName" type="text" placeholder="John" />
          </label>
          <label>Last Name
            <input id="lastName" type="text" placeholder="Doe" />
          </label>
        </div>

        <div class="row">
          <label class="checkbox">
            <input id="marketing" type="checkbox" checked />
            Marketing (Purpose #1)
          </label>
          <label class="checkbox">
            <input id="profiling" type="checkbox" />
            Profiling (Purpose #2)
          </label>
        </div>

        <div class="actions">
          <button type="submit">Submit (API)</button>
          <label style="display:inline-flex;align-items:center;gap:8px;font-size:12px;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;background:#fff;">
            <input id="isTest" type="checkbox" checked />
            test=true
          </label>
        </div>
      </form>

      <div class="log">
        <strong>Submit log</strong>
        <pre id="log"></pre>
      </div>
    </section>

    <p class="muted">
      Tip: open DevTools ‚Üí Network and filter <code>consentreceipts</code>. If it fails, check the API response in the log.
    </p>
  </main>

  <script>
    (function () {
      // =========================
      // ‚úÖ CONFIG
      // =========================
      const API_URL = "https://privacyportaltrial.onetrust.com/request/v1/consentreceipts";

      // Purpose IDs (your existing IDs)
      const PURPOSE_MARKETING_ID = "d8aecf6d-3f4a-4354-b752-8a6663b5d83f";
      const PURPOSE_PROFILING_ID = "eaddf865-9b70-445b-a36c-fdddc9de1697";
      const CHECKED_TRANSACTION_TYPE = "CONFIRMED";

      // JWT storage
      const TOKEN_KEY = "ucpm_requestInformation_jwt";
      const getJwt = () => {
        const jwt = sessionStorage.getItem(TOKEN_KEY);
        return (jwt && jwt.trim().length > 50) ? jwt.trim() : null;
      };

      // =========================
      // UI: Token Vault
      // =========================
      const vaultDetails = document.getElementById("vaultDetails");
      const vaultDot = document.getElementById("vaultDot");
      const vaultText = document.getElementById("vaultText");
      const jwtInput = document.getElementById("jwtInput");
      const btnSaveJwt = document.getElementById("btnSaveJwt");
      const btnClearJwt = document.getElementById("btnClearJwt");

      function setVaultStatus(ok, msg) {
        if (ok) vaultDot.classList.add("ok");
        else vaultDot.classList.remove("ok");
        vaultText.textContent = msg || (ok ? "Loaded" : "Not loaded");
      }

      function refreshVaultUI() {
        const ok = !!getJwt();
        setVaultStatus(ok, ok ? "Loaded" : "Not loaded");
      }

      btnSaveJwt.addEventListener("click", () => {
        const val = (jwtInput.value || "").trim();
        if (!val || val.length < 50) {
          setVaultStatus(false, "Invalid JWT");
          jwtInput.focus();
          return;
        }
        sessionStorage.setItem(TOKEN_KEY, val);
        jwtInput.value = "";
        setVaultStatus(true, "Saved");
        vaultDetails.open = false;
      });

      btnClearJwt.addEventListener("click", () => {
        sessionStorage.removeItem(TOKEN_KEY);
        jwtInput.value = "";
        setVaultStatus(false, "Cleared");
        vaultDetails.open = true;
      });

      document.addEventListener("click", (e) => {
        if (!vaultDetails.open) return;
        if (!vaultDetails.contains(e.target)) vaultDetails.open = false;
      });

      refreshVaultUI();

      // =========================
      // Form submit ‚Üí API
      // =========================
      const logEl = document.getElementById("log");
      const form = document.getElementById("externalForm");

      const emailEl = document.getElementById("email");
      const phoneEl = document.getElementById("phone");
      const firstNameEl = document.getElementById("firstName");
      const lastNameEl = document.getElementById("lastName");
      const marketingEl = document.getElementById("marketing");
      const profilingEl = document.getElementById("profiling");
      const isTestEl = document.getElementById("isTest");

      function log(text, obj) {
        const ts = new Date().toISOString();
        const msg = obj ? text + "\n" + JSON.stringify(obj, null, 2) : text;
        logEl.textContent = `[${ts}] ${msg}\n\n` + logEl.textContent;
        console.log(text, obj || "");
      }

      function buildPurposes() {
        const purposes = [];
        if (marketingEl.checked) purposes.push({ Id: PURPOSE_MARKETING_ID, TransactionType: CHECKED_TRANSACTION_TYPE });
        if (profilingEl.checked) purposes.push({ Id: PURPOSE_PROFILING_ID, TransactionType: CHECKED_TRANSACTION_TYPE });
        return purposes;
      }

      function buildRequestBody() {
        const jwt = getJwt();
        if (!jwt) {
          vaultDetails.open = true;
          throw new Error("Missing JWT. Open Token Vault and click Save.");
        }

        const identifier = (emailEl.value || "").trim();
        if (!identifier) throw new Error("Missing email (identifier).");

        const body = {
          identifier,
          requestInformation: jwt,
          purposes: buildPurposes(),
          dsDataElements: {
            Mobile: (phoneEl.value || "").trim(),
            FirstName: (firstNameEl.value || "").trim(),
            LastName: (lastNameEl.value || "").trim()
          }
        };

        if (isTestEl.checked) body.test = true;
        return body;
      }

      async function sendConsentReceipt(body) {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        const contentType = res.headers.get("content-type") || "";
        const data = contentType.includes("application/json")
          ? await res.json().catch(() => null)
          : await res.text().catch(() => "");

        if (!res.ok) {
          const err = new Error(`API error: HTTP ${res.status}`);
          err.details = data;
          throw err;
        }

        return { status: res.status, data };
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        let body;
        try {
          body = buildRequestBody();
        } catch (err) {
          log("‚ùå Cannot submit", { message: err.message || String(err) });
          return;
        }

        const safe = JSON.parse(JSON.stringify(body));
        safe.requestInformation = "[REDACTED_JWT]";
        log(`POST ${API_URL}`, safe);

        try {
          const result = await sendConsentReceipt(body);
          log("‚úÖ Success", result);
        } catch (err) {
          log("‚ùå Failed", { message: err.message || String(err), details: err.details || null });
        }
      });
    })();
  </script>
</body>
</html>
