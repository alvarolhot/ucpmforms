<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UCPM Form Test</title>

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #f6f7f9; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 24px; }
    .card { background: #fff; border-radius: 12px; padding: 18px; margin: 18px 0; box-shadow: 0 2px 10px rgba(0,0,0,.06); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 12px 0; }
    label { display: grid; gap: 6px; font-size: 14px; }
    input { padding: 10px 12px; border: 1px solid #d7dbe0; border-radius: 10px; font-size: 14px; }
    .checkbox { display: flex; align-items: center; gap: 8px; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; align-items: center; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #d7dbe0; background: #fff; cursor: pointer; }
    button:hover { background: #f2f4f7; }
    .muted { color: #6b7280; font-size: 13px; }
    .log { margin-top: 14px; border: 1px dashed #d7dbe0; border-radius: 12px; padding: 12px; background: #fafafa; }
    .log pre { margin: 0; white-space: pre-wrap; word-break: break-word; font-size: 12px; }
    .embedded-container { border: 1px solid #eef0f3; border-radius: 12px; padding: 12px; min-height: 160px; background: #fff; }

    .pill {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 6px 10px; border: 1px solid #e5e7eb; border-radius: 999px;
      background: #fff; font-size: 12px; color: #374151;
    }

    /* back bar */
    .back-bar{
      margin-bottom: 16px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }
    .back-btn {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 14px; border-radius: 999px; text-decoration: none;
      font-size: 13px; font-weight: 600; color: #1d4ed8;
      background: rgba(37,99,235,.08); border: 1px solid rgba(37,99,235,.25);
      white-space: nowrap;
    }

    /* Token vault chip */
    details.vaultTopRight{ position: relative; margin-left: auto; }
    summary.vaultChip{
      list-style: none; cursor: pointer;
      display:inline-flex; align-items:center; gap: 10px;
      padding: 8px 10px; border-radius: 999px;
      border: 1px solid #e5e7eb; background: rgba(255,255,255,.9);
      font-size: 12.5px; font-weight: 900; color:#0f172a;
      user-select:none; white-space: nowrap;
    }
    summary.vaultChip::-webkit-details-marker{ display:none; }
    .vaultChipRight{
      display:flex; align-items:center; gap: 8px;
      font-weight: 800; font-size: 12px; color:#64748b;
      padding: 5px 8px; border: 1px solid #e5e7eb;
      border-radius: 999px; background: rgba(255,255,255,.8);
      white-space: nowrap;
    }
    .dot { width:8px; height:8px; border-radius: 999px; background:#ef4444; }
    .dot.ok { background:#22c55e; }

    .vaultPopover{
      position: absolute; right: 0; top: calc(100% + 10px);
      width: min(520px, 86vw);
      border: 1px solid #eef0f3; border-radius: 12px;
      background: #fff; box-shadow: 0 18px 50px rgba(2, 6, 23, .14);
      padding: 10px 12px 12px; z-index: 50;
    }
    textarea.vaultInput{
      width:100%; min-height: 60px; resize: vertical;
      padding: 8px 10px; border: 1px solid #d7dbe0; border-radius: 10px;
      font-size: 12px; line-height: 1.3; outline: none; background: #fff;
    }
    .vaultActions{ display:flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; align-items:center; }
    .btnSm{
      padding: 8px 10px; border-radius: 10px;
      border: 1px solid #e5e7eb; background: #fff;
      font-size: 12px; font-weight: 800; cursor: pointer; white-space: nowrap;
    }
    .btnSm:hover{ background:#f8fafc; }
    .btnPrimary{ border-color: rgba(37,99,235,.30); background: rgba(37,99,235,.10); color:#1d4ed8; }
    .btnDanger{ border-color: rgba(239,68,68,.30); background: rgba(239,68,68,.08); color:#b91c1c; }
    .vaultHint{ margin: 8px 0 0; font-size: 11.5px; color:#64748b; line-height: 1.35; }
    code.k { font-size: 11.5px; }

    /* Embedded status */
    .embedStatus{
      display:flex; align-items:center; gap:10px;
      padding: 8px 10px; border: 1px solid #e5e7eb;
      border-radius: 10px; background: #fafafa;
      margin-bottom: 10px; font-size: 12.5px; color:#334155;
    }
    .embedStatus strong{ font-weight: 900; }
    .embedStatus .badge{
      margin-left:auto;
      display:inline-flex; align-items:center; gap:8px;
      padding: 4px 8px; border-radius: 999px;
      border: 1px solid #e5e7eb; background:#fff;
      color:#64748b; font-weight: 800; white-space: nowrap;
    }

    @media (max-width: 720px) { .row { grid-template-columns: 1fr; } }
    @media (max-width: 520px){
      .back-bar{ flex-direction: column; align-items: flex-start; }
      details.vaultTopRight{ margin-left: 0; }
      .vaultPopover{ left: 0; right: auto; width: 92vw; }
      .embedStatus{ flex-wrap: wrap; }
      .embedStatus .badge{ margin-left: 0; }
    }
  </style>
</head>

<body>
  <main class="wrap">
    <div class="back-bar">
      <a href="./index.html" class="back-btn">← Volver al selector</a>

      <details class="vaultTopRight" id="vaultDetails">
        <summary class="vaultChip" title="Token Vault (requestInformation JWT)">
          <span>⚙️ Token Vault</span>
          <span class="vaultChipRight" id="vaultStatus">
            <span class="dot" id="vaultDot"></span>
            <span id="vaultText">No cargado</span>
          </span>
        </summary>

        <div class="vaultPopover">
          <textarea class="vaultInput" id="jwtInput" placeholder="Pega aquí el JWT (no se commitea)…"></textarea>

          <div class="vaultActions">
            <button class="btnSm btnPrimary" type="button" id="btnSaveJwt">Guardar</button>
            <button class="btnSm btnDanger" type="button" id="btnClearJwt">Borrar</button>
          </div>

          <p class="vaultHint">
            Se guarda en <strong>sessionStorage</strong> (solo esta pestaña). Clave:
            <code class="k">sessionStorage["ucpm_requestInformation_jwt"]</code>
          </p>
        </div>
      </details>
    </div>

    <h1>Test UCPM – CMS form + Embedded form</h1>

    <section class="card">
      <h2>1) Formulario tipo CMS (custom) → Consent Receipt API</h2>
      <p class="muted">
        Envía un receipt a un Collection Point vía <code>/request/v1/consentreceipts</code> usando el JWT del Collection Point como <code>requestInformation</code>.
      </p>

      <form id="cmsForm">
        <div class="row">
          <label>Email (identifier)
            <input id="email" type="email" required placeholder="example@otprivacy.com" />
          </label>
          <label>Teléfono (Mobile)
            <input id="phone" type="tel" placeholder="+34..." />
          </label>
        </div>

        <div class="row">
          <label class="checkbox">
            <input id="marketing" type="checkbox" checked /> Marketing (Purpose #1)
          </label>
          <label class="checkbox">
            <input id="profiling" type="checkbox" /> Profiling (Purpose #2)
          </label>
        </div>

        <div class="actions">
          <button type="submit">Enviar lead (API)</button>
          <label class="pill">
            <input id="isTest" type="checkbox" checked />
            test=true
          </label>
        </div>
      </form>

      <div class="log">
        <strong>Log</strong>
        <pre id="log"></pre>
      </div>
    </section>

    <section class="card">
      <h2>2) Embedded Form UCPM</h2>
      <p class="muted">Aquí se renderiza el formulario estándar de OneTrust (si lo necesitas).</p>

      <div class="embedStatus" id="embedStatus">
        <strong>Estado embedded:</strong>
        <span id="embedMsg">Pendiente de carga…</span>
        <span class="badge"><span class="dot" id="embedDot"></span><span id="embedBadgeText">IDLE</span></span>
      </div>

      <div id="ucpm-embedded-form" class="embedded-container"></div>
    </section>

    <p class="muted">Consejo: DevTools → Network filtra por <code>OtFormStub.js</code> y mira Console si no pinta.</p>
  </main>

<script>
(function () {
  // ========= CONFIG =========
  const API_URL = "https://privacyportaltrial.onetrust.com/request/v1/consentreceipts";

  // Embedded (TU script real)
  const EMBED_SCRIPT_SRC = "https://privacyportaltrial.onetrust.com/consent-embedded-forms/consent-receipt-scripts/OtFormStub.js";
  const EMBED_COLLECTION_POINT_ID = "86cfa775-f542-42b6-8f6d-30a22fc81ba1";
  const EMBED_WORKER = "https://consent-api.onetrust.com";

  // JWT (sessionStorage)
  const TOKEN_KEY = "ucpm_requestInformation_jwt";
  const getJwt = () => {
    const jwt = sessionStorage.getItem(TOKEN_KEY);
    return (jwt && jwt.trim().length > 50) ? jwt.trim() : null;
  };

  // ========= UI: Token Vault =========
  const jwtInput = document.getElementById("jwtInput");
  const btnSaveJwt = document.getElementById("btnSaveJwt");
  const btnClearJwt = document.getElementById("btnClearJwt");
  const vaultDot = document.getElementById("vaultDot");
  const vaultText = document.getElementById("vaultText");
  const vaultDetails = document.getElementById("vaultDetails");

  function setVaultStatus(ok, msg) {
    if (ok) vaultDot.classList.add("ok"); else vaultDot.classList.remove("ok");
    vaultText.textContent = msg || (ok ? "JWT cargado" : "No cargado");
  }
  function refreshVaultUI() { setVaultStatus(!!getJwt(), getJwt() ? "JWT cargado" : "No cargado"); }
  refreshVaultUI();

  btnSaveJwt.addEventListener("click", () => {
    const val = (jwtInput.value || "").trim();
    if (!val || val.length < 50) { setVaultStatus(false, "JWT inválido"); jwtInput.focus(); return; }
    sessionStorage.setItem(TOKEN_KEY, val);
    jwtInput.value = "";
    setVaultStatus(true, "Guardado");
    vaultDetails.open = false;
  });

  btnClearJwt.addEventListener("click", () => {
    sessionStorage.removeItem(TOKEN_KEY);
    jwtInput.value = "";
    setVaultStatus(false, "Borrado");
    vaultDetails.open = true;
  });

  document.addEventListener("click", (e) => {
    if (!vaultDetails.open) return;
    if (!vaultDetails.contains(e.target)) vaultDetails.open = false;
  });

  // ========= Log =========
  const logEl = document.getElementById("log");
  function log(text, obj) {
    const ts = new Date().toISOString();
    const msg = obj ? text + "\n" + JSON.stringify(obj, null, 2) : text;
    logEl.textContent = "[" + ts + "] " + msg + "\n\n" + logEl.textContent;
    console.log(text, obj || "");
  }

  // ========= API submit =========
  const form = document.getElementById("cmsForm");
  const isTestEl = document.getElementById("isTest");
  const emailEl = document.getElementById("email");
  const phoneEl = document.getElementById("phone");
  const marketingEl = document.getElementById("marketing");
  const profilingEl = document.getElementById("profiling");

  const PURPOSE_MARKETING_ID = "d8aecf6d-3f4a-4354-b752-8a6663b5d83f";
  const PURPOSE_PROFILING_ID = "eaddf865-9b70-445b-a36c-fdddc9de1697";

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const jwt = getJwt();
    if (!jwt) { vaultDetails.open = true; log("❌ Falta JWT"); return; }

    const purposes = [];
    if (marketingEl.checked) purposes.push({ Id: PURPOSE_MARKETING_ID, TransactionType: "CONFIRMED" });
    if (profilingEl.checked) purposes.push({ Id: PURPOSE_PROFILING_ID, TransactionType: "CONFIRMED" });

    const body = {
      identifier: (emailEl.value || "").trim(),
      requestInformation: jwt,
      purposes,
      dsDataElements: { Mobile: (phoneEl.value || "").trim() }
    };
    if (isTestEl.checked) body.test = true;

    const safe = JSON.parse(JSON.stringify(body));
    safe.requestInformation = "[REDACTED_JWT]";
    log("POST " + API_URL, safe);

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const data = await res.json().catch(() => null);
      if (!res.ok) throw Object.assign(new Error("HTTP " + res.status), { details: data });
      log("✅ OK", { status: res.status, data });
    } catch (err) {
      log("❌ ERROR", { message: err.message, details: err.details || null });
    }
  });

  // ========= Embedded loader (baseline) =========
  const embedMsg = document.getElementById("embedMsg");
  const embedDot = document.getElementById("embedDot");
  const embedBadgeText = document.getElementById("embedBadgeText");
  const embedContainer = document.getElementById("ucpm-embedded-form");

  function setEmbedStatus(state, msg) {
    embedMsg.textContent = msg || "";
    embedBadgeText.textContent = state.toUpperCase();
    embedDot.classList.remove("ok");
    embedDot.style.background = "#94a3b8"; // idle
    if (state === "loading") embedDot.style.background = "#f59e0b";
    if (state === "error") embedDot.style.background = "#ef4444";
    if (state === "ok") { embedDot.style.background = "#22c55e"; embedDot.classList.add("ok"); }
  }

  function loadEmbeddedForm() {
    setEmbedStatus("loading", "Cargando script de OneTrust…");
    embedContainer.innerHTML = "";

    // elimina carga previa
    const prev = document.getElementById("ot-embed-script");
    if (prev) prev.remove();

    const s = document.createElement("script");
    s.id = "ot-embed-script";
    s.src = EMBED_SCRIPT_SRC;
    s.async = true;

    s.setAttribute("data-id", EMBED_COLLECTION_POINT_ID);
    s.setAttribute("worker", EMBED_WORKER);

    s.onload = () => {
      setEmbedStatus("ok", "Script cargado. Si no pinta, mira Console/Network.");
      // debug rápido
      console.log("OT embedded globals:", {
        OtFormStub: window.OtFormStub,
        OneTrust: window.OneTrust,
        Onetrust: window.Onetrust,
        __OT__: window.__OT__
      });
    };

    s.onerror = () => setEmbedStatus("error", "No se pudo cargar el script (bloqueo/red).");

    // lo insertamos justo después del contenedor
    embedContainer.insertAdjacentElement("afterend", s);
  }

  setEmbedStatus("idle", "Iniciando…");
  window.addEventListener("load", loadEmbeddedForm);
})();
</script>
</body>
</html>
