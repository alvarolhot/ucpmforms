<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>UCPM Test</title>

<style>
:root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
body { margin:0; background:#f6f7f9; }
.wrap { max-width:980px; margin:0 auto; padding:24px; }
.card { background:#fff; border-radius:12px; padding:18px; margin:18px 0; box-shadow:0 2px 10px rgba(0,0,0,.06); }
.row { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin:12px 0; }
label { display:grid; gap:6px; font-size:14px; }
input { padding:10px; border:1px solid #d7dbe0; border-radius:10px; }
button { padding:10px 12px; border-radius:10px; border:1px solid #d7dbe0; background:#fff; cursor:pointer; }
button:hover { background:#f2f4f7; }
.log { margin-top:14px; border:1px dashed #d7dbe0; border-radius:12px; padding:12px; background:#fafafa; }
.log pre { margin:0; font-size:12px; white-space:pre-wrap; }

.back-bar { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:16px; }
.back-btn { padding:8px 14px; border-radius:999px; text-decoration:none; font-size:13px; font-weight:600; color:#1d4ed8; background:rgba(37,99,235,.08); border:1px solid rgba(37,99,235,.25); }

details { position:relative; }
summary { cursor:pointer; font-weight:700; font-size:13px; }
textarea { width:100%; min-height:60px; padding:8px; border-radius:10px; border:1px solid #d7dbe0; }

.embedded-container { border:1px solid #eef0f3; border-radius:12px; padding:12px; min-height:160px; }

/* Forzar visibilidad embedded */
#ucpm-embedded-form, #ot-embedded-form, #onetrust-embedded-form,
.ot-form, .onetrust-form {
  min-height:520px !important;
}
.embedded-container iframe {
  width:100% !important;
  min-height:520px !important;
  border:0;
}
</style>
</head>

<body>
<main class="wrap">

<div class="back-bar">
<a href="./index.html" class="back-btn">← Volver</a>

<details>
<summary>⚙️ Token Vault</summary>
<textarea id="jwtInput" placeholder="Pega aquí el JWT"></textarea>
<button id="saveJwt">Guardar</button>
<button id="clearJwt">Borrar</button>
</details>
</div>

<h1>UCPM API + Embedded</h1>

<section class="card">
<h2>1) API Custom Form</h2>

<form id="cmsForm">
<div class="row">
<label>Email
<input id="email" type="email" required />
</label>
<label>Teléfono
<input id="phone" type="tel" />
</label>
</div>

<div class="row">
<label><input id="marketing" type="checkbox" checked /> Marketing</label>
<label><input id="profiling" type="checkbox" /> Profiling</label>
</div>

<button type="submit">Enviar</button>
</form>

<div class="log">
<strong>Log</strong>
<pre id="log"></pre>
</div>
</section>

<section class="card">
<h2>2) Embedded Form</h2>

<div class="embedded-container">
<div id="ucpm-embedded-form"></div>
<div id="ot-embedded-form"></div>
<div id="onetrust-embedded-form"></div>
<div class="ot-form"></div>
<div class="onetrust-form"></div>
</div>

<!-- SCRIPT EMBEDDED INLINE (IMPORTANTE) -->
<script
src="https://privacyportaltrial.onetrust.com/consent-embedded-forms/consent-receipt-scripts/OtFormStub.js"
data-id="86cfa775-f542-42b6-8f6d-30a22fc81ba1"
worker="https://consent-api.onetrust.com">
</script>

</section>

</main>

<script>
const API_URL="https://privacyportaltrial.onetrust.com/request/v1/consentreceipts";
const TOKEN_KEY="ucpm_requestInformation_jwt";

document.getElementById("saveJwt").onclick=()=>{
sessionStorage.setItem(TOKEN_KEY,document.getElementById("jwtInput").value.trim());
alert("JWT guardado en sessionStorage");
};
document.getElementById("clearJwt").onclick=()=>{
sessionStorage.removeItem(TOKEN_KEY);
alert("JWT eliminado");
};

function log(text,obj){
const ts=new Date().toISOString();
document.getElementById("log").textContent=
"["+ts+"] "+text+"\n"+
(obj?JSON.stringify(obj,null,2):"")+"\n\n"+
document.getElementById("log").textContent;
}

document.getElementById("cmsForm").addEventListener("submit",async e=>{
e.preventDefault();
const jwt=sessionStorage.getItem(TOKEN_KEY);
if(!jwt){ alert("No hay JWT cargado"); return; }

const body={
identifier:document.getElementById("email").value.trim(),
requestInformation:jwt,
purposes:[
document.getElementById("marketing").checked?{Id:"d8aecf6d-3f4a-4354-b752-8a6663b5d83f",TransactionType:"CONFIRMED"}:null,
document.getElementById("profiling").checked?{Id:"eaddf865-9b70-445b-a36c-fdddc9de1697",TransactionType:"CONFIRMED"}:null
].filter(Boolean),
dsDataElements:{
Mobile:document.getElementById("phone").value.trim()
}
};

log("POST consentreceipts",body);

try{
const res=await fetch(API_URL,{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify(body)
});
const data=await res.json().catch(()=>null);
log("RESULT", {status:res.status,data});
}catch(err){
log("ERROR",err.message);
}
});

// DEBUG GLOBALS
console.log("OT embedded globals:",{
OtFormStub:window.OtFormStub,
OneTrust:window.OneTrust,
Onetrust:window.Onetrust,
__OT__:window.__OT__
});
</script>

</body>
</html>
